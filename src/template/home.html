
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
	<!-- GOOGLE FONT-->
	<link href='http://fonts.googleapis.com/css?family=Roboto:400,300,700italic,700,500&amp;subset=latin,latin-ext' rel='stylesheet' type='text/css'>
	<link href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,700,800" rel="stylesheet" type="text/css">
	<!-- /GOOGLE FONT-->
	
	<link href='http://fonts.googleapis.com/css?family=Playball' rel='stylesheet' type='text/css'>
	<link href="{{static_url('css/bootstrap.css')}}" rel="stylesheet">
	<link href="{{static_url('css/bootstrap-datetimepicker.min.css')}}" rel="stylesheet">

    <title>Rail Monitor</title>

    <!-- Bootstrap core CSS -->
    
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="../../assets/js/html5shiv.js"></script>
      <script src="../../assets/js/respond.min.js"></script>
    <![endif]-->
	<style>
		body {
		  padding-top: 50px;
		}
		.starter-template {
		  padding: 40px 15px;
		  text-align: center;
		}
	</style>  	
	<style>
			/* tell the SVG path to be a thin blue line without any area fill */
			path {
				stroke: steelblue;
				stroke-width: 1;
				fill: none;
			}
			
			.axis {
			  shape-rendering: crispEdges;
			}
 
			.x.axis line {
			  stroke: lightgrey;
			}
 
			.x.axis .minor {
			  stroke-opacity: .5;
			}
 
			.x.axis path {
			  display: none;
			}
 
			.y.axis line, .y.axis path {
			  fill: none;
			  stroke: #000;
			}
		</style>
  </head>
	
  <body>

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Rail Monitor</a>
        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Map</a></li>            
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

    <div class="container">
    
      <div class="starter-template">
       <form>
      		<div class="row">
  				<div class="col-md-5"> 
  					<div class="input-group input-group-lg datetimepicker">
               			<input id="startdatetime"  type="text" class="form-control" placeholder="Start" style="height:48px;">
                  		<span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
           			</div>
           		</div>
  				<div class="col-md-5">
  					<div class="input-group input-group-lg datetimepicker" >
               			<input id="enddatetime" type="text" class="form-control" placeholder="End" style="height:48px;">
                  		<span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
           			</div>
  				</div>
  				<div class="col-md-2 text-right">
  					<input type="submit" class="btn btn-default btn-lg btn-primary" value="Audit!" />
  				</div>
  			</div>
          
        </form>	
      </div>
      <div class="row">
      	<div class="col-md-6">
	      <div id="map-canvas" style="height:500px;width:100%;">
	      </div>
	    </div>
	    <div class="col-md-6">
	      <div id="graph">
	      </div>
	    </div>
      </div>
      <br />
    </div><!-- /.container -->

	
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
   <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>    	
	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=visualization"></script>
	<script src="{{static_url('js/bootstrap.js')}}"></script>
	<script src="{{static_url('js/d3.min.js')}}"></script>
	<script src="{{static_url('js/moment.min.js')}}"></script>	
	<script src="{{static_url('js/bootstrap-datetimepicker.js')}}"></script>	
	<script type="text/javascript">
		$(document).ready(function(){
			var map, pointarray, heatmap;

			
			function initialize() {
			  var mapOptions = {
			    zoom: 13,
			    center: new google.maps.LatLng(37.774546, -122.433523),
			    mapTypeId: google.maps.MapTypeId.SATELLITE
			  };
			
			  map = new google.maps.Map(document.getElementById('map-canvas'),
			      mapOptions);
			
			  heatmap = new google.maps.visualization.HeatmapLayer({
			  	radius:100, 
			  });
			
			  heatmap.setMap(map);
			  
			}
						
			initialize();

			var handleData = function(data){
				var pts = [];
				var bounds = new google.maps.LatLngBounds();
				for(var d in data){
					var pt= data[d];
					//{location: new google.maps.LatLng(37.782, -122.447), weight: 0.5},
					var location = new google.maps.LatLng(pt.latitude, pt.longitude);
					pts.push({'location':location, 'weight':parseFloat(pt.gforce== null? 0: pt.gforce )});
					bounds.extend(location);
				}
				var pointArray = new google.maps.MVCArray(pts);			
			  	heatmap.setData(pointArray)
			  	map.setCenter(bounds.getCenter());//set map to bounds center
			  	map.fitBounds(bounds);
			  	//map.panToBounds(bounds);//move to bounds
			  	
			  	//draw graph
			  	parseDate = d3.time.format("%Y-%m-%d %H:%M:%S").parse;
			  	
			}
			
			$('.datetimepicker').datetimepicker();
		   	
		   	$('form').submit(function(e){
		   		e.preventDefault();
		   		//09/30/2013 02:48
		   		try{
		   			data = {'start': moment($('#startdatetime').val(), 'MM/DD/YYYY HH:mm').unix(),
			   				'end': moment($('#enddatetime').val(), 'MM/DD/YYYY HH:mm').unix(),
			   				'rfidTagNum':0
			   				};
			   		$.ajax({
			   			type:'POST',
			   			url:'/event',
			   			data:data,
			   			dataType:'JSON',
			   			success:function(data){
			   				console.log(data);
			   				if(data){
			   					handleData(data);
			   				}
			   			},
			   			error:function(e){
			   				console.log(e);
			   			},
			 
			   		
			   		})//end ajax
		   		}catch (ex){
		   			console.log(ex);
		   		}
		   	})
		});
	</script>
	<script>
		/* implementation heavily influenced by http://bl.ocks.org/1166403 */
		
		// define dimensions of graph
		var m = [80, 80, 80, 80]; // margins
		var w = 500 - m[1] - m[3]; // width
		var h = 400 - m[0] - m[2]; // height
		
		// create a simple data array that we'll plot with a line (this array represents only the Y values, X will just be the index location)
		var data = [3, 6, 2, 7, 5, 2, 0, 3, 8, 9, 2, 5, 9, 3, 6, 3, 6, 2, 7, 5, 2, 1, 3, 8, 9, 2, 5, 9, 2, 7];
 
		// X scale will fit all values from data[] within pixels 0-w
		var x = d3.scale.linear().domain([0, data.length]).range([0, w]);
		// Y scale will fit values from 0-10 within pixels h-0 (Note the inverted domain for the y-scale: bigger is up!)
		var y = d3.scale.linear().domain([0, 10]).range([h, 0]);
			// automatically determining max range can work something like this
			// var y = d3.scale.linear().domain([0, d3.max(data)]).range([h, 0]);
 
		// create a line function that can convert data[] into x and y points
		var line = d3.svg.line()
			// assign the X function to plot our line as we wish
			.x(function(d,i) { 
				// verbose logging to show what's actually being done
				console.log('Plotting X value for data point: ' + d + ' using index: ' + i + ' to be at: ' + x(i) + ' using our xScale.');
				// return the X coordinate where we want to plot this datapoint
				return x(i); 
			})
			.y(function(d) { 
				// verbose logging to show what's actually being done
				console.log('Plotting Y value for data point: ' + d + ' to be at: ' + y(d) + " using our yScale.");
				// return the Y coordinate where we want to plot this datapoint
				return y(d); 
			})
 
			// Add an SVG element with the desired dimensions and margin.
		var graph = d3.select("#graph").append("svg:svg")
			      .attr("width", w + m[1] + m[3])
			      .attr("height", h + m[0] + m[2])
			    .append("svg:g")
			      .attr("transform", "translate(" + m[3] + "," + m[0] + ")");
 
			// create yAxis
		var xAxis = d3.time.scale().domain([new Date(0), new Date(data.length)]);//d3.svg.axis().scale(x).tickSize(-h).tickSubdivide(true);
			// Add the x-axis.
			graph.append("svg:g")
			      .attr("class", "x axis")
			      .attr("transform", "translate(0," + h + ")")
			      .call(xAxis);
 
 
			// create left yAxis
		var yAxisLeft = d3.svg.axis().scale(y).ticks(4).orient("left");
			// Add the y-axis to the left
			graph.append("svg:g")
			      .attr("class", "y axis")
			      .attr("transform", "translate(-25,0)")
			      .call(yAxisLeft);
			
  			// Add the line by appending an svg:path element with the data line we created above
			// do this AFTER the axes above so that the line is above the tick-lines
  		graph.append("svg:path").attr("d", line(data));
			
 
	</script>
  </body>
</html>
